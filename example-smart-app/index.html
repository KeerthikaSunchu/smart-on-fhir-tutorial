<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
    <title>Example-SMART-App</title>
  </head>
  <body>
    <div id='errors'></div>
    <div id="loading" class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
    <div id='holder'>
      <h2>Example-SMART-App</h2>

      <h2>Patient Resource</h2>
      <table>
        <tr>
          <th>First Name:</th>
          <td id='fname'></td>
        </tr>
        <tr>
          <th>Last Name:</th>
          <td id='lname'></td>
        </tr>
        <tr>
          <th>Gender:</th>
          <td id='gender'></td>
        </tr>
        <tr>
          <th>Date of Birth:</th>
          <td id='birthdate'></td>
        </tr>
      </table>
      <h2>Observation Resource</h2>
      <table>
        <tr>
          <th>Height:</th>
          <td id='height'></td>
        </tr>
        <tr>
          <th>Systolic Blood Pressure:</th>
          <td id='systolicbp'></td>
        </tr>
        <tr>
          <th>Diastolic Blood Pressure:</th>
          <td id='diastolicbp'></td>
        </tr>
        <tr>
          <th>LDL:</th>
          <td id='ldl'></td>
        </tr>
        <tr>
          <th>HDL:</th>
          <td id='hdl'></td>
        </tr>
      </table>
    </div>

    <!-- Include FHIR Client JS Library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient@latest/build/fhir-client.min.js"></script>

    <!-- Application-level JavaScript -->
    <script src='./src/js/example-smart-app.js'></script>

    <!-- jQuery for convenience -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    
    <script>
      // Function to extract data
      async function extractData() {
        try {
          const client = await FHIR.oauth2.ready();
          const patient = await client.request("Patient");
          const observation = await client.request("Observation?patient=" + patient.id);

          return { patient, observation };
        } catch (error) {
          console.error("Error calling FHIR service:", error);
          throw new Error("Failed to call FHIR Service");
        }
      }

      // Function to draw visualization
      function drawVisualization(p) {
        const patient = p.patient;
        const observation = p.observation;

        $('#fname').text(patient.name[0].given.join(" "));
        $('#lname').text(patient.name[0].family);
        $('#gender').text(patient.gender);
        $('#birthdate').text(patient.birthDate);

        const height = observation.entry.find(entry => entry.resource.code.coding[0].code === "8302-2");
        const systolicbp = observation.entry.find(entry => entry.resource.code.coding[0].code === "8480-6");
        const diastolicbp = observation.entry.find(entry => entry.resource.code.coding[0].code === "8462-4");
        const ldl = observation.entry.find(entry => entry.resource.code.coding[0].code === "18262-6");
        const hdl = observation.entry.find(entry => entry.resource.code.coding[0].code === "2085-9");

        $('#height').text(height ? height.resource.valueQuantity.value : "N/A");
        $('#systolicbp').text(systolicbp ? systolicbp.resource.component[0].valueQuantity.value : "N/A");
        $('#diastolicbp').text(diastolicbp ? diastolicbp.resource.component[1].valueQuantity.value : "N/A");
        $('#ldl').text(ldl ? ldl.resource.valueQuantity.value : "N/A");
        $('#hdl').text(hdl ? hdl.resource.valueQuantity.value : "N/A");

        $('#loading').hide();
      }

      // Call extractData and handle success/failure
      extractData().then(
        function(p) {
          drawVisualization(p);
        },
        function() {
          $('#loading').hide();
          $('#errors').html('<p>Failed to call FHIR Service</p>');
        }
      );
    </script>
  </body>
</html>
