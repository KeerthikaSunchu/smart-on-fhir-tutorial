<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Example-SMART-App</title>
  </head>
  <body>
    <div id="errors"></div>
    <div id="loading">Loading...</div>
    <div id="holder" style="display: none;">
      <h2>Patient Resource</h2>
      <table>
        <tr>
          <th>First Name:</th>
          <td id="fname"></td>
        </tr>
        <tr>
          <th>Last Name:</th>
          <td id="lname"></td>
        </tr>
        <tr>
          <th>Gender:</th>
          <td id="gender"></td>
        </tr>
        <tr>
          <th>Date of Birth:</th>
          <td id="birthdate"></td>
        </tr>
        <tr>
          <th>Age:</th>
          <td id="age"></td>
        </tr>
      </table>
      <h2>Observation Resource</h2>
      <table>
        <tr>
          <th>Height:</th>
          <td id="height"></td>
        </tr>
        <tr>
          <th>Systolic Blood Pressure:</th>
          <td id="systolicbp"></td>
        </tr>
        <tr>
          <th>Diastolic Blood Pressure:</th>
          <td id="diastolicbp"></td>
        </tr>
        <tr>
          <th>LDL:</th>
          <td id="ldl"></td>
        </tr>
        <tr>
          <th>HDL:</th>
          <td id="hdl"></td>
        </tr>
      </table>
    </div>
    <script src="node_modules/fhirclient/build/fhir-client.js"></script>
    <script>
      async function extractData() {
        try {
          const client = await FHIR.oauth2.ready();
          const patient = await client.request("Patient");
          const observations = await client.request("Observation", {
            graph: {
              type: 'Observation',
              query: {
                code: {
                  $or: [
                    'http://loinc.org|8302-2', 'http://loinc.org|8462-4',
                    'http://loinc.org|8480-6', 'http://loinc.org|2085-9',
                    'http://loinc.org|2089-1', 'http://loinc.org|55284-4'
                  ]
                }
              }
            }
          });
          return { patient, observations };
        } catch (error) {
          document.getElementById('errors').innerHTML = '<p> Failed to call FHIR Service </p>';
          console.error(error);
        }
      }

      function drawVisualization(data) {
        const { patient, observations } = data;
        const byCodes = (obs, code) => obs.filter(o => o.code.coding.some(c => c.code === code));

        const gender = patient.gender;
        const dob = new Date(patient.birthDate);
        const dobStr = `${dob.getMonth() + 1}/${dob.getDate()}/${dob.getFullYear()}`;
        const fname = patient.name[0].given.join(' ');
        const lname = patient.name[0].family.join(' ');

        const height = byCodes(observations, '8302-2');
        const systolicbp = getBloodPressureValue(byCodes(observations, '55284-4'), '8480-6');
        const diastolicbp = getBloodPressureValue(byCodes(observations, '55284-4'), '8462-4');
        const hdl = byCodes(observations, '2085-9');
        const ldl = byCodes(observations, '2089-1');

        const p = {
          fname,
          lname,
          gender,
          birthdate: dobStr,
          age: calculateAge(dob),
          height: height.length ? `${height[0].valueQuantity.value} ${height[0].valueQuantity.unit}` : '',
          systolicbp: systolicbp || '',
          diastolicbp: diastolicbp || '',
          ldl: ldl.length ? `${ldl[0].valueQuantity.value} ${ldl[0].valueQuantity.unit}` : '',
          hdl: hdl.length ? `${hdl[0].valueQuantity.value} ${hdl[0].valueQuantity.unit}` : ''
        };

        document.getElementById('fname').innerHTML = p.fname;
        document.getElementById('lname').innerHTML = p.lname;
        document.getElementById('gender').innerHTML = p.gender;
        document.getElementById('birthdate').innerHTML = p.birthdate;
        document.getElementById('age').innerHTML = p.age;
        document.getElementById('height').innerHTML = p.height;
        document.getElementById('systolicbp').innerHTML = p.systolicbp;
        document.getElementById('diastolicbp').innerHTML = p.diastolicbp;
        document.getElementById('ldl').innerHTML = p.ldl;
        document.getElementById('hdl').innerHTML = p.hdl;

        document.getElementById('loading').style.display = 'none';
        document.getElementById('holder').style.display = 'block';
      }

      function getBloodPressureValue(observations, typeOfPressure) {
        const obs = observations.find(observation => 
          observation.component.some(component => 
            component.code.coding.some(coding => coding.code === typeOfPressure)
          )
        );
        return obs ? obs.component.find(component => 
          component.code.coding.some(coding => coding.code === typeOfPressure)
        ).valueQuantity.value : undefined;
      }

      function calculateAge(dob) {
        const diff_ms = Date.now() - dob.getTime();
        const age_dt = new Date(diff_ms);
        return Math.abs(age_dt.getUTCFullYear() - 1970);
      }

      document.addEventListener('DOMContentLoaded', async () => {
        const data = await extractData();
        if (data) {
          drawVisualization(data);
        }
      });
    </script>
  </body>
</html>
