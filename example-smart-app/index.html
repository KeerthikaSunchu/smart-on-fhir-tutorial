import React, { useState, useEffect } from 'react';
import { PatientVisualizer } from 'fhir-visualizers';
import { Line } from 'react-chartjs-2';
import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend } from 'chart.js';
import { Container, Button, Form } from "react-bootstrap";
import 'bootstrap/dist/css/bootstrap.min.css';
import { useForm } from "react-hook-form";

// Register the required components for Chart.js
ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend);

export default function App(props) {
  const client = props.client;
  const [patient, setPatient] = useState(null);
  const [observations, setObservations] = useState([]);
  const { register, handleSubmit, formState: { errors } } = useForm();

  useEffect(() => {
    client.patient.read().then((patient) => setPatient(patient));
    client.request("Observation?patient=" + client.patient.id)
      .then((response) => {
        const heightWeightObservations = response.entry.filter(entry =>
          entry.resource.code.coding.some(coding => 
            coding.code === '8302-2' || // Height
            coding.code === '29463-7' // Weight
          )
        );
        setObservations(heightWeightObservations);
      });
  }, [client]);

  const onSubmit = data => {
    let np = patient;
    np.name[0].given[0] = data.fname;
    np.name[0].family = data.lname;
    setPatient(np);
    client.update(np);
  };

  const chartData = {
    labels: observations.map(obs => new Date(obs.resource.effectiveDateTime).toLocaleDateString()),
    datasets: [
      {
        label: 'Height (cm)',
        data: observations.filter(obs => obs.resource.code.coding.some(c => c.code === '8302-2')).map(obs => obs.resource.valueQuantity.value),
        borderColor: 'rgba(75,192,192,1)',
        fill: false,
      },
      {
        label: 'Weight (kg)',
        data: observations.filter(obs => obs.resource.code.coding.some(c => c.code === '29463-7')).map(obs => obs.resource.valueQuantity.value),
        borderColor: 'rgba(192,75,75,1)',
        fill: false,
      }
    ]
  };

  return (
    <div id="app">
      {patient ? (
        <>
          <PatientVisualizer patient={patient} />
          <Container>
            <h4>Update Patient Name</h4>
            <Form onSubmit={handleSubmit(onSubmit)}>
              <Form.Group className="mb-3" controlId="formFirst">
                <Form.Label>First</Form.Label>
                <Form.Control type="text" {...register("fname")} defaultValue={patient.name[0].given.join(' ')} />
              </Form.Group>
              <Form.Group className="mb-3" controlId="formLast">
                <Form.Label>Last</Form.Label>
                <Form.Control type="text" {...register("lname")} defaultValue={patient.name[0].family} />
              </Form.Group>
              <Button type="submit">Update</Button>
            </Form>
          </Container>
          <Container>
            <h4>Height and Weight Over Time</h4>
            <Line data={chartData} />
          </Container>
        </>
      ) : (
        <h1>Loading</h1>
      )}
    </div>
  );
}
